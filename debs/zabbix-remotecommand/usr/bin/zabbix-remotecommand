#!/bin/bash

#TODO: prüfe ob zabbix user rechte

service=$1

if [ "$service" = "" ]; then 
	echo $0 service
	echo $0 start | stop
	exit 1
fi

if [ "$service" = "start" ]; then 
	rm /tmp/zabbix-remotecommand.stop
	echo "$0 wird beim nächsten evend wieder ausgeführt :)"
	exit 0
fi
if [ "$service" = "stop" ]; then
	touch /tmp/zabbix-remotecommand.stop
	echo "$0 wird bis zum neustart nicht mehr ausgeführt :("
	exit 0
fi

function log() {
	#TODO: pipe
	echo $1
	echo "$(date) $1" >> /var/log/zabbix/zabbix_rc.log
}

function init() {
	deamon=$1
	state=$2
	
	#TODO: check systemd

	if which service >/dev/null 2>&1; then
		service $deamon $state 2>&1 | tee -a /var/log/zabbix/zabbix_rc.log 
		s=$?
		log "service $deamon $state ($s)"
		return $s
	elif which invoke-rc.d >/dev/null 2>&1; then
		invoke-rc.d $deamon $state 2>&1 | tee -a /var/log/zabbix/zabbix_rc.log
		s=$?
		log "invoke-rc.d $deamon $state ($s)"
		return $s
	else
		/etc/init.d/$deamon $state 2>&1 | tee -a /var/log/zabbix/zabbix_rc.log
		s=$?
		log "/etc/init.d/$deamon $state ($s)"
		return $s
	fi
}

if [ -f /tmp/zabbix-remotecommand.stop ]; then
	log "$service durfte nicht ausgeführt werden."
	exit 255
fi

case $service in
    "apache")
	log "apache2 restart"
	
	init apache2 stop
	#TODO: ps axf | grep apache | wc -l || killall apache || reboot
	init apache2 start
	;;

    "ftp")
	log "ftp restart"

	if [ -x /etc/init.d/proftpd ]; then 
		echo proftpd
		init proftpd stop
		init proftpd start
	elif [ -x /etc/init.d/xinetd ]; then 
		echo xinetd
		init xinetd stop
		init xinetd start
	else
		echo default
		init proftpd stop
		init proftpd start	
	fi
	;;

    "smtp")
	log "smtp restart"
	init postfix stop
	init postfix start
	;;

    "pop3" | "imap")
	log "imap restart"

	if [ -x /etc/init.d/courier-imap ]; then
		init courier-imap stop
		init courier-imap start
	elif [ -x /etc/init.d/dovecot ]; then
		init dovecot stop
		init dovecot start
	else
		echo "no mail services"
	fi
	;;

    "mysql")
	log "mysql restart"
	init mysql stop
	init mysql start
	;;


    "panel")
	log "panel restart"
	if [ -x /etc/init.d/psa ]; then
		init psa stop
		init psa start
	elif [ -x /etc/init.d/sw-cp-server ]; then
		init sw-cp-server stop
		init sw-cp-server start
	elif [ -x /etc/init.d/lcclient ]; then
		init lcclient stop
		init lcclient start
	elif [ -x /etc/init.d/liveconfig ]; then
		init liveconfig stop
		init liveconfig start
	else
		echo "no panel found"
	fi
	;;

    *)
	echo "ERROR: No Service found."
	exit 2
	;;
esac

exit 0
